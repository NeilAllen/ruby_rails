Binstubs are wrapper scripts around executables (sometimes refered to as
"binaries", although they don't have to be compiled) whose purpose is to prepare
the environment before dispatching the call to the original executable.

In the Ruby world, the most common binstubs are the ones that RubyGems generates
after installing a gem that contains executables. But binstubs can be written in
any language, and it often makes sense to create them manually.


## RubyGems

Let's see what happens when we `gem install rspec-core`. [RSpec ships with an
executable][rspec] located at `./exe/rspec` inside of the gem. After the
installation, RubyGems will provide us with the following executables:

1. `<ruby-prefix>/bin/rspec` (binstub generated by RubyGems)
1. `<ruby-prefix>/lib/ruby/gems/1.9.1/gems/rspec-core-XX.YY/exe/rspec` (original)

The first file is a binstub created to wrap the second. RubyGems put it in
`<ruby-prefix>/bin` because that directory is considered to already be in our
`$PATH`. (That's the job of Ruby version managers.)

The directory where RubyGems installed the second file (the original) isn't in
our `$PATH`, but even if it was, it wouldn't be safe to run it directly because
executables in Ruby projects *often aren't meant* to be called directly without
any setup. At minimum, they require `$RUBYOPT` to be set so that they can
require the source files of the project they belong to.

The generated binstub `<ruby-prefix>/bin/rspec` is a short Ruby script,
presented in a slightly simplified form here:

```rb
#!/usr/bin/env ruby
require 'rubygems'

# Prepares the $LOAD_PATH by adding to it lib directories of the gem and
# its dependencies:
gem 'rspec-core'

# Loads the original executable
load Gem.bin_path('rspec-core', 'rspec')
```

The purpose of every RubyGems binstub is to use RubyGems to prepare the
`$LOAD_PATH` before calling the original executable.


## rbenv

rbenv adds its own "shims" directory to `$PATH` which contains binstubs for
every executable related to Ruby. There are binstubs for `ruby`, `gem`, and for
all RubyGems binstubs across each installed Ruby version.

When you call `rspec` on the command-line, it results in this call chain:

1. `$RBENV_ROOT/shims/rspec` (rbenv shim)
1. `$RBENV_ROOT/versions/1.9.3-pXXX/bin/rspec` (RubyGems binstub)
1. `$RBENV_ROOT/versions/1.9.3-pXXX/lib/ruby/gems/1.9.1/gems/rspec-core-XX.YY/exe/rspec` (original)

An rbenv shim, presented here in a slightly simplified form, is a short shell script:

```sh
#!/usr/bin/env bash
export RBENV_ROOT="$HOME/.rbenv"
exec rbenv exec "$(basename "$0")" "$@"
```

The purpose of rbenv's shims is to route every call to a ruby executable through
`rbenv exec`, which ensures it gets executed with the right Ruby version.


## Project-specific binstubs

When you run `rspec` within your project's directory, rbenv can ensure that it
will get executed with the Ruby version configured for that project. However,
nothing will ensure that the right *version of RSpec* gets activated; in fact,
RubyGems will simply activate the latest RSpec version even if your project
depends on an older version. In the context of a project, this is unwanted
behavior.

This is why `bundle exec <command>` is so often needed. It ensures the right
versions of dependencies get activated, ensuring a consistent ruby runtime
environment. However, `bundle exec` is a pain to always write.

### Bundler-generated binstubs

Bundler can install binstubs in your project for all executables contained in
the current bundle.

```
bundle install --binstubs
```

This creates, for example, `./bin/rspec` (simplified version):

```rb
#!/usr/bin/env ruby
require 'rubygems'
# Prepares the $LOAD_PATH by adding to it lib directories of all gems in the
# project's bundle:
require 'bundler/setup'
load Gem.bin_path('rspec-core', 'rspec')
```

RSpec can now be easily called with `bin/rspec`.

If you go one step further and prepend `./bin` to your $PATH, you can simply
call `rspec` instead of `bin/rspec`. This is recommended so that you are able to
launch RSpec the same way in a context of a project and outside of it.

### Manually created binstubs

Now that you know that binstubs are simple scripts written in any lanuage and
understand their purpose, you should consider creating own binstubs for your
project or your local development environment.

For instance, in the context of a Rails application, a manually generated
binstub to run Unicorn could be in `./bin/unicorn`:

```rb
#!/usr/bin/env ruby
require_relative '../config/boot'
load Gem.bin_path('unicorn', 'unicorn')
```

Using `bin/unicorn` now ensures that Unicorn will run in the exact same
environment as the application: same Ruby version, same Gemfile dependencies.
This is true even if the binstub was called from outside the app, for instance
as `/path/to/app/current/bin/unicorn`.


  [rspec]: https://github.com/rspec/rspec-core/blob/v2.12.2/exe/rspec
